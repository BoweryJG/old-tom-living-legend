import { openaiService } from './openaiService';\nimport { characterPersonalityService, CharacterPersonality } from './characterPersonalityService';\nimport { conversationMemoryService } from './conversationMemoryService';\nimport { emotionalAIService } from './emotionalAIService';\nimport { elevenlabsService } from './elevenlabsService';\n\ninterface AskOldTomRequest {\n  question: string;\n  childAge?: number;\n  sessionId: string;\n  context?: {\n    currentEmotion?: string;\n    previousTopics?: string[];\n    learningLevel?: 'beginner' | 'intermediate' | 'advanced';\n    timeOfDay?: 'morning' | 'afternoon' | 'evening';\n  };\n  inputMethod: 'voice' | 'text';\n  voiceData?: any;\n}\n\ninterface AskOldTomResponse {\n  textResponse: string;\n  audioResponse?: string;\n  emotion: string;\n  character: CharacterPersonality;\n  educationalContent: {\n    topic: string;\n    learningObjectives: string[];\n    ageAppropriate: boolean;\n    difficultyLevel: 'simple' | 'moderate' | 'complex';\n    relatedTopics: string[];\n  };\n  followUpSuggestions: string[];\n  safetyValidation: {\n    appropriate: boolean;\n    concerns: string[];\n    recommendations: string[];\n  };\n  conversationContext: {\n    updated: boolean;\n    relationshipLevel: string;\n    newMemories: string[];\n  };\n}\n\ninterface KnowledgeArea {\n  id: string;\n  name: string;\n  ageRanges: {\n    '3-5': {\n      vocabulary: string[];\n      concepts: string[];\n      examples: string[];\n    };\n    '6-8': {\n      vocabulary: string[];\n      concepts: string[];\n      examples: string[];\n    };\n    '9-12': {\n      vocabulary: string[];\n      concepts: string[];\n      examples: string[];\n    };\n  };\n  safetyGuidelines: string[];\n  educationalObjectives: string[];\n}\n\nclass AskOldTomService {\n  private knowledgeBase: Map<string, KnowledgeArea> = new Map();\n  private responseTemplates: Map<string, any> = new Map();\n  private safetyFilters: Map<string, RegExp[]> = new Map();\n  private conversationStarters: string[] = [];\n\n  constructor() {\n    this.initializeKnowledgeBase();\n    this.initializeResponseTemplates();\n    this.initializeSafetyFilters();\n    this.initializeConversationStarters();\n  }\n\n  private initializeKnowledgeBase() {\n    // Marine Biology Knowledge\n    this.knowledgeBase.set('marine_biology', {\n      id: 'marine_biology',\n      name: 'Marine Biology and Ocean Life',\n      ageRanges: {\n        '3-5': {\n          vocabulary: ['fish', 'whale', 'big', 'swim', 'water', 'ocean', 'friendly', 'family'],\n          concepts: ['Fish live in the ocean', 'Whales are very big', 'Ocean animals are friends'],\n          examples: ['Old Tom is a big whale who lives in the ocean and helps people']\n        },\n        '6-8': {\n          vocabulary: ['marine animals', 'ecosystem', 'habitat', 'species', 'cooperation', 'behavior'],\n          concepts: ['Ocean ecosystems support many species', 'Animals cooperate for survival', 'Each species has unique behaviors'],\n          examples: ['Orcas like Old Tom hunt in groups and can learn to work with humans']\n        },\n        '9-12': {\n          vocabulary: ['biodiversity', 'symbiotic relationships', 'apex predator', 'marine conservation', 'cetacean intelligence'],\n          concepts: ['Marine biodiversity supports ocean health', 'Orcas are highly intelligent apex predators', 'Human-wildlife partnerships can benefit both species'],\n          examples: ['Old Tom\\'s pack demonstrated advanced cognitive abilities by developing hunting partnerships with whalers']\n        }\n      },\n      safetyGuidelines: [\n        'Focus on positive human-animal relationships',\n        'Emphasize respect for marine life',\n        'Avoid graphic details about predation',\n        'Promote ocean conservation'\n      ],\n      educationalObjectives: [\n        'Understand marine ecosystems',\n        'Appreciate animal intelligence',\n        'Learn about conservation',\n        'Develop respect for nature'\n      ]\n    });\n\n    // Friendship and Cooperation\n    this.knowledgeBase.set('friendship_cooperation', {\n      id: 'friendship_cooperation',\n      name: 'Friendship, Loyalty, and Cooperation',\n      ageRanges: {\n        '3-5': {\n          vocabulary: ['friend', 'help', 'kind', 'share', 'care', 'together', 'nice'],\n          concepts: ['Friends help each other', 'Being kind is important', 'We can work together'],\n          examples: ['Old Tom and George were best friends who helped each other every day']\n        },\n        '6-8': {\n          vocabulary: ['cooperation', 'trust', 'loyalty', 'partnership', 'teamwork', 'respect'],\n          concepts: ['Trust builds strong friendships', 'Cooperation helps everyone succeed', 'Loyalty means staying faithful to friends'],\n          examples: ['Old Tom showed loyalty by always coming when George needed help with whaling']\n        },\n        '9-12': {\n          vocabulary: ['mutual respect', 'interdependence', 'commitment', 'reciprocity', 'alliance'],\n          concepts: ['Successful partnerships require mutual respect', 'Interdependence creates stronger communities', 'Commitment builds lasting relationships'],\n          examples: ['The partnership between Old Tom and the whalers created a unique alliance that benefited both species']\n        }\n      },\n      safetyGuidelines: [\n        'Emphasize healthy friendship boundaries',\n        'Promote kindness and empathy',\n        'Encourage inclusive friendships',\n        'Teach conflict resolution'\n      ],\n      educationalObjectives: [\n        'Develop social skills',\n        'Understand cooperation',\n        'Build empathy',\n        'Learn about loyalty'\n      ]\n    });\n\n    // Historical Context\n    this.knowledgeBase.set('maritime_history', {\n      id: 'maritime_history',\n      name: 'Maritime History and Coastal Life',\n      ageRanges: {\n        '3-5': {\n          vocabulary: ['boat', 'sailor', 'long ago', 'work', 'ocean', 'fishing'],\n          concepts: ['People used to work on boats', 'Long ago, life was different', 'People worked hard by the ocean'],\n          examples: ['George was a sailor who worked on boats near the ocean long, long ago']\n        },\n        '6-8': {\n          vocabulary: ['whaling', 'maritime', 'coastal community', 'tradition', 'historical', 'livelihood'],\n          concepts: ['Coastal communities depended on the ocean', 'Maritime traditions shaped culture', 'Historical practices evolved over time'],\n          examples: ['In the early 1900s, Eden was a whaling town where people like George made their living from the sea']\n        },\n        '9-12': {\n          vocabulary: ['sustainable practices', 'maritime heritage', 'economic dependence', 'technological advancement', 'cultural evolution'],\n          concepts: ['Historical maritime practices provide lessons for modern conservation', 'Economic dependence on natural resources requires balance', 'Cultural traditions can evolve with understanding'],\n          examples: ['The Eden whaling station represents a unique chapter in maritime history where humans and orcas developed an unprecedented working relationship']\n        }\n      },\n      safetyGuidelines: [\n        'Present historical context age-appropriately',\n        'Focus on positive aspects of human-nature relationships',\n        'Avoid graphic details about historical practices',\n        'Connect historical lessons to modern conservation'\n      ],\n      educationalObjectives: [\n        'Understand historical context',\n        'Learn about cultural traditions',\n        'Appreciate historical figures',\n        'Connect past to present'\n      ]\n    });\n\n    // Ocean Science and Geography\n    this.knowledgeBase.set('ocean_science', {\n      id: 'ocean_science',\n      name: 'Ocean Science and Geography',\n      ageRanges: {\n        '3-5': {\n          vocabulary: ['water', 'deep', 'waves', 'fish', 'blue', 'big', 'cold', 'warm'],\n          concepts: ['The ocean is very big and deep', 'Ocean water moves in waves', 'Different ocean areas have different temperatures'],\n          examples: ['Old Tom lived in the deep blue ocean where the water was sometimes warm and sometimes cold']\n        },\n        '6-8': {\n          vocabulary: ['currents', 'tides', 'temperature', 'depth', 'marine zones', 'weather patterns'],\n          concepts: ['Ocean currents move water around the world', 'Tides change throughout the day', 'Ocean depth affects marine life'],\n          examples: ['Old Tom knew how to use ocean currents and tides to help the whalers find other whales']\n        },\n        '9-12': {\n          vocabulary: ['oceanography', 'thermoclines', 'pelagic zones', 'continental shelf', 'marine productivity'],\n          concepts: ['Oceanographic conditions affect marine ecosystems', 'Different ocean zones support different life forms', 'Ocean science helps us understand marine behavior'],\n          examples: ['Old Tom\\'s knowledge of local oceanographic conditions made him an invaluable partner to the Eden whalers']\n        }\n      },\n      safetyGuidelines: [\n        'Emphasize ocean safety and respect',\n        'Promote scientific curiosity',\n        'Encourage environmental awareness',\n        'Connect science to conservation'\n      ],\n      educationalObjectives: [\n        'Understand ocean systems',\n        'Develop scientific thinking',\n        'Learn about geography',\n        'Appreciate natural systems'\n      ]\n    });\n  }\n\n  private initializeResponseTemplates() {\n    // Old Tom's response templates based on topics and age groups\n    this.responseTemplates.set('marine_biology_3-5', {\n      intro: [\"Let me tell you about my ocean friends, little one!\", \"Oh, the ocean is full of wonderful creatures!\"],\n      explanation: [\"You see, {concept} because {reason}. It's quite magical!\"],\n      connection: [\"Just like how I {example}, ocean animals {behavior}.\"],\n      encouragement: [\"You're such a curious explorer! What else would you like to know?\"]\n    });\n\n    this.responseTemplates.set('friendship_3-5', {\n      intro: [\"Friendship is one of the most beautiful things in the ocean and on land!\"],\n      explanation: [\"George and I were the very best of friends because {reason}.\"],\n      connection: [\"Just like how you might {child_example}, friends {action}.\"],\n      encouragement: [\"Being a good friend is something you can practice every day!\"]\n    });\n\n    this.responseTemplates.set('learning_encouragement', {\n      curious: [\"What a wonderful question! Your curiosity makes my old heart happy.\"],\n      confused: [\"That's quite alright, young explorer. Even I had to learn these things slowly.\"],\n      excited: [\"I can feel your excitement from here! Let me share something amazing with you.\"],\n      thoughtful: [\"You're thinking deeply about this, just like a true ocean scholar.\"]\n    });\n  }\n\n  private initializeSafetyFilters() {\n    // Inappropriate content filters\n    this.safetyFilters.set('violence', [\n      /kill/gi, /death/gi, /hurt/gi, /pain/gi, /blood/gi, /attack/gi, /fight/gi\n    ]);\n\n    this.safetyFilters.set('scary_content', [\n      /scary/gi, /frightening/gi, /terrifying/gi, /horrible/gi, /nightmare/gi\n    ]);\n\n    this.safetyFilters.set('inappropriate_topics', [\n      /dating/gi, /romance/gi, /adult/gi, /grown.?up.?stuff/gi\n    ]);\n  }\n\n  private initializeConversationStarters() {\n    this.conversationStarters = [\n      \"What would you like to know about the ocean today?\",\n      \"Have you ever wondered how whales talk to each other?\",\n      \"Would you like to hear about the time George and I worked together?\",\n      \"What's your favorite thing about the ocean?\",\n      \"Do you have any questions about friendship and helping others?\",\n      \"Would you like to learn about the amazing creatures I've met in the deep sea?\"\n    ];\n  }\n\n  public async askOldTom(request: AskOldTomRequest): Promise<AskOldTomResponse> {\n    try {\n      // Step 1: Safety validation\n      const safetyValidation = this.validateQuestionSafety(request.question, request.childAge);\n      if (!safetyValidation.appropriate) {\n        return this.createSafeRedirectResponse(request, safetyValidation);\n      }\n\n      // Step 2: Emotion analysis\n      const emotionalAnalysis = await emotionalAIService.processChildInteraction(\n        {\n          text: request.question,\n          voiceData: request.voiceData,\n          sessionData: {\n            childAge: request.childAge,\n            sessionDuration: 0, // Will be calculated by memory service\n            responseTime: 1000, // Average response time\n            interactionCount: 1\n          }\n        },\n        'old-tom',\n        this.extractTopicFromQuestion(request.question)\n      );\n\n      // Step 3: Determine knowledge area and age-appropriate content\n      const knowledgeArea = this.identifyKnowledgeArea(request.question);\n      const ageGroup = this.determineAgeGroup(request.childAge || 7);\n      const educationalContent = this.generateEducationalContent(knowledgeArea, ageGroup, request.question);\n\n      // Step 4: Get conversation context\n      const conversationContext = conversationMemoryService.getConversationContext(\n        request.sessionId,\n        'old-tom'\n      );\n\n      // Step 5: Generate Old Tom's response\n      const characterResponse = await this.generateOldTomResponse(\n        request,\n        emotionalAnalysis,\n        knowledgeArea,\n        ageGroup,\n        conversationContext\n      );\n\n      // Step 6: Generate audio if requested\n      let audioResponse: string | undefined;\n      if (request.inputMethod === 'voice') {\n        audioResponse = await this.generateAudioResponse(\n          characterResponse,\n          emotionalAnalysis.recommendedCharacterResponse.emotion,\n          ageGroup\n        );\n      }\n\n      // Step 7: Update conversation memory\n      const memoryResult = await this.updateConversationMemory(\n        request,\n        characterResponse,\n        emotionalAnalysis,\n        educationalContent\n      );\n\n      // Step 8: Generate follow-up suggestions\n      const followUpSuggestions = this.generateFollowUpSuggestions(\n        knowledgeArea,\n        ageGroup,\n        emotionalAnalysis.detectedEmotion.primary\n      );\n\n      return {\n        textResponse: characterResponse,\n        audioResponse,\n        emotion: emotionalAnalysis.recommendedCharacterResponse.emotion,\n        character: 'old-tom',\n        educationalContent,\n        followUpSuggestions,\n        safetyValidation,\n        conversationContext: {\n          updated: memoryResult.updated,\n          relationshipLevel: conversationContext.relationshipLevel,\n          newMemories: memoryResult.newMemories\n        }\n      };\n\n    } catch (error) {\n      console.error('Error in askOldTom:', error);\n      return this.createErrorResponse(request);\n    }\n  }\n\n  private validateQuestionSafety(question: string, childAge?: number): {\n    appropriate: boolean;\n    concerns: string[];\n    recommendations: string[];\n  } {\n    const concerns: string[] = [];\n    const recommendations: string[] = [];\n    let appropriate = true;\n\n    // Check against safety filters\n    for (const [category, patterns] of this.safetyFilters.entries()) {\n      for (const pattern of patterns) {\n        if (pattern.test(question)) {\n          concerns.push(`Contains ${category.replace('_', ' ')} content`);\n          appropriate = false;\n        }\n      }\n    }\n\n    // Age-specific checks\n    if (childAge && childAge < 6) {\n      const complexWords = ['death', 'violence', 'scary', 'dangerous', 'frightening'];\n      complexWords.forEach(word => {\n        if (question.toLowerCase().includes(word)) {\n          concerns.push(`Topic may be too complex for age ${childAge}`);\n          recommendations.push('Redirect to gentler, age-appropriate topics');\n        }\n      });\n    }\n\n    // Educational value check\n    const educationalKeywords = ['learn', 'teach', 'explain', 'show', 'tell', 'how', 'what', 'why', 'where'];\n    const hasEducationalValue = educationalKeywords.some(keyword => \n      question.toLowerCase().includes(keyword)\n    );\n\n    if (!hasEducationalValue && question.length < 10) {\n      recommendations.push('Encourage more specific questions to enhance learning');\n    }\n\n    return {\n      appropriate,\n      concerns,\n      recommendations\n    };\n  }\n\n  private identifyKnowledgeArea(question: string): string {\n    const questionLower = question.toLowerCase();\n    \n    // Marine biology keywords\n    const marineKeywords = ['whale', 'ocean', 'fish', 'sea', 'marine', 'swim', 'underwater', 'creature', 'animal'];\n    if (marineKeywords.some(keyword => questionLower.includes(keyword))) {\n      return 'marine_biology';\n    }\n    \n    // Friendship keywords\n    const friendshipKeywords = ['friend', 'help', 'cooperation', 'together', 'loyalty', 'trust', 'partnership'];\n    if (friendshipKeywords.some(keyword => questionLower.includes(keyword))) {\n      return 'friendship_cooperation';\n    }\n    \n    // History keywords\n    const historyKeywords = ['george', 'whaling', 'old days', 'history', 'past', 'long ago', 'before'];\n    if (historyKeywords.some(keyword => questionLower.includes(keyword))) {\n      return 'maritime_history';\n    }\n    \n    // Ocean science keywords\n    const scienceKeywords = ['current', 'tide', 'deep', 'temperature', 'wave', 'depth', 'geography'];\n    if (scienceKeywords.some(keyword => questionLower.includes(keyword))) {\n      return 'ocean_science';\n    }\n    \n    return 'general';\n  }\n\n  private determineAgeGroup(age: number): '3-5' | '6-8' | '9-12' {\n    if (age <= 5) return '3-5';\n    if (age <= 8) return '6-8';\n    return '9-12';\n  }\n\n  private generateEducationalContent(knowledgeArea: string, ageGroup: string, question: string): AskOldTomResponse['educationalContent'] {\n    const knowledge = this.knowledgeBase.get(knowledgeArea);\n    \n    if (!knowledge) {\n      return {\n        topic: 'General Ocean Knowledge',\n        learningObjectives: ['Explore curiosity about the ocean'],\n        ageAppropriate: true,\n        difficultyLevel: 'simple',\n        relatedTopics: ['marine life', 'friendship', 'ocean exploration']\n      };\n    }\n\n    const ageContent = knowledge.ageRanges[ageGroup as keyof typeof knowledge.ageRanges];\n    \n    return {\n      topic: knowledge.name,\n      learningObjectives: knowledge.educationalObjectives,\n      ageAppropriate: true,\n      difficultyLevel: ageGroup === '3-5' ? 'simple' : ageGroup === '6-8' ? 'moderate' : 'complex',\n      relatedTopics: this.generateRelatedTopics(knowledgeArea, question)\n    };\n  }\n\n  private generateRelatedTopics(knowledgeArea: string, question: string): string[] {\n    const topicMap: Record<string, string[]> = {\n      'marine_biology': ['whale families', 'ocean food chains', 'marine conservation', 'ocean exploration'],\n      'friendship_cooperation': ['teamwork', 'helping others', 'trust building', 'communication'],\n      'maritime_history': ['sailing ships', 'coastal communities', 'ocean traditions', 'historical figures'],\n      'ocean_science': ['ocean currents', 'marine geography', 'weather patterns', 'underwater exploration'],\n      'general': ['ocean wonders', 'marine animals', 'friendship stories', 'ocean adventures']\n    };\n\n    return topicMap[knowledgeArea] || topicMap['general'];\n  }\n\n  private async generateOldTomResponse(\n    request: AskOldTomRequest,\n    emotionalAnalysis: any,\n    knowledgeArea: string,\n    ageGroup: string,\n    conversationContext: any\n  ): Promise<string> {\n    const knowledge = this.knowledgeBase.get(knowledgeArea);\n    const ageContent = knowledge?.ageRanges[ageGroup as keyof typeof knowledge.ageRanges];\n    \n    // Build context for character response\n    const characterContext = {\n      characterPersonality: [\n        'Wise and ancient ocean dweller',\n        'Patient teacher and protector',\n        'Loyal friend with deep ocean knowledge',\n        'Gentle giant with infinite compassion'\n      ],\n      memories: [\n        'Partnership with George Davidson',\n        'Years of cooperation with whalers',\n        'Protecting other whales and humans',\n        'Witnessing ocean changes over decades'\n      ],\n      conversationHistory: conversationContext.conversationHistory || [],\n      currentMood: emotionalAnalysis.recommendedCharacterResponse.emotion,\n      backstory: 'Old Tom, the legendary orca of Eden, with decades of wisdom and friendship with humans'\n    };\n\n    // Generate response using character personality service\n    const baseResponse = await characterPersonalityService.generateCharacterResponse(\n      'old-tom',\n      request.question,\n      {\n        topic: this.extractTopicFromQuestion(request.question),\n        childAge: request.childAge,\n        emotionalNeeds: emotionalAnalysis.safetyAlerts,\n        previousInteractions: conversationContext.sessionInfo?.totalInteractions || 0,\n        relationshipLevel: conversationContext.relationshipLevel || 'stranger',\n        currentSession: {\n          startTime: conversationContext.sessionInfo?.startTime || Date.now(),\n          messageCount: 1,\n          dominantEmotions: [emotionalAnalysis.detectedEmotion.primary]\n        }\n      },\n      emotionalAnalysis.recommendedCharacterResponse.emotion\n    );\n\n    // Enhance response with age-appropriate knowledge\n    const enhancedResponse = this.enhanceResponseWithKnowledge(\n      baseResponse,\n      knowledgeArea,\n      ageGroup,\n      request.question,\n      ageContent\n    );\n\n    return enhancedResponse;\n  }\n\n  private enhanceResponseWithKnowledge(\n    baseResponse: string,\n    knowledgeArea: string,\n    ageGroup: string,\n    question: string,\n    ageContent: any\n  ): string {\n    if (!ageContent) return baseResponse;\n\n    // Add relevant vocabulary and concepts naturally\n    let enhancedResponse = baseResponse;\n    \n    // For younger children, ensure simple vocabulary\n    if (ageGroup === '3-5') {\n      // Replace complex words with simpler ones\n      enhancedResponse = enhancedResponse.replace(/ecosystem/g, 'ocean home');\n      enhancedResponse = enhancedResponse.replace(/cooperation/g, 'working together');\n      enhancedResponse = enhancedResponse.replace(/marine/g, 'ocean');\n    }\n    \n    // Add educational examples if appropriate\n    if (ageContent.examples && ageContent.examples.length > 0) {\n      const relevantExample = ageContent.examples[0];\n      if (!enhancedResponse.includes(relevantExample.substring(0, 20))) {\n        enhancedResponse += ` For example, ${relevantExample}.`;\n      }\n    }\n    \n    return enhancedResponse;\n  }\n\n  private async generateAudioResponse(\n    textResponse: string,\n    emotion: string,\n    ageGroup: string\n  ): Promise<string> {\n    try {\n      return await elevenlabsService.generateContextualSpeech(\n        textResponse,\n        {\n          character: 'old-tom',\n          emotion: emotion,\n          situation: 'educational',\n          childAge: ageGroup === '3-5' ? 4 : ageGroup === '6-8' ? 7 : 10,\n          urgency: 'low'\n        }\n      );\n    } catch (error) {\n      console.error('Error generating audio response:', error);\n      return '';\n    }\n  }\n\n  private async updateConversationMemory(\n    request: AskOldTomRequest,\n    response: string,\n    emotionalAnalysis: any,\n    educationalContent: any\n  ): Promise<{ updated: boolean; newMemories: string[] }> {\n    try {\n      const memoryId = await conversationMemoryService.addConversationMemory({\n        participantId: request.sessionId,\n        characterId: 'old-tom',\n        userInput: {\n          text: request.question,\n          emotion: emotionalAnalysis.detectedEmotion.primary,\n          context: educationalContent.topic,\n          inputMethod: request.inputMethod\n        },\n        characterResponse: {\n          text: response,\n          emotion: emotionalAnalysis.recommendedCharacterResponse.emotion,\n          responseTime: 2000 // Approximate response time\n        },\n        sessionData: {\n          sessionId: request.sessionId,\n          childAge: request.childAge,\n          relationshipLevel: 5, // Base relationship level\n          topicsDiscussed: [educationalContent.topic],\n          emotionalState: [emotionalAnalysis.detectedEmotion.primary]\n        },\n        learningObjectives: {\n          topic: educationalContent.topic,\n          complexity: educationalContent.difficultyLevel,\n          achieved: true\n        },\n        safetyFlags: {\n          contentAppropriate: true,\n          emotionalSupport: emotionalAnalysis.safetyAlerts.length === 0,\n          educationalValue: true\n        }\n      });\n\n      return {\n        updated: true,\n        newMemories: [`Learned about ${educationalContent.topic}`, `Expressed ${emotionalAnalysis.detectedEmotion.primary} emotion`]\n      };\n    } catch (error) {\n      console.error('Error updating conversation memory:', error);\n      return { updated: false, newMemories: [] };\n    }\n  }\n\n  private generateFollowUpSuggestions(\n    knowledgeArea: string,\n    ageGroup: string,\n    emotion: string\n  ): string[] {\n    const suggestions: string[] = [];\n    \n    // Base suggestions by knowledge area\n    const areaSuggestions: Record<string, string[]> = {\n      'marine_biology': [\n        'Would you like to learn about whale families?',\n        'Shall I tell you about other ocean creatures I know?',\n        'Would you like to hear about how whales talk to each other?'\n      ],\n      'friendship_cooperation': [\n        'Would you like to hear about a time George and I helped each other?',\n        'Shall I tell you about other friendships in the ocean?',\n        'Would you like to learn about working together as a team?'\n      ],\n      'maritime_history': [\n        'Would you like to hear more stories about the old days?',\n        'Shall I tell you about life in coastal towns long ago?',\n        'Would you like to learn about ships and sailing?'\n      ],\n      'ocean_science': [\n        'Would you like to explore the deepest parts of the ocean?',\n        'Shall I tell you about ocean currents and how they work?',\n        'Would you like to learn about ocean weather?'\n      ]\n    };\n    \n    suggestions.push(...(areaSuggestions[knowledgeArea] || areaSuggestions['marine_biology']));\n    \n    // Emotion-based suggestions\n    if (emotion === 'excited') {\n      suggestions.push('I can tell you\\'re excited! What interests you most?');\n    } else if (emotion === 'curious') {\n      suggestions.push('You have such wonderful questions! What else would you like to explore?');\n    } else if (emotion === 'confused') {\n      suggestions.push('Would you like me to explain that in a different way?');\n    }\n    \n    // Age-appropriate suggestions\n    if (ageGroup === '3-5') {\n      suggestions.push('Would you like to hear a gentle ocean story?');\n    } else if (ageGroup === '9-12') {\n      suggestions.push('Would you like to explore some advanced ocean science?');\n    }\n    \n    return suggestions.slice(0, 4); // Return up to 4 suggestions\n  }\n\n  private createSafeRedirectResponse(\n    request: AskOldTomRequest,\n    safetyValidation: any\n  ): AskOldTomResponse {\n    const redirectResponse = \"That's an interesting question, young explorer! But let me tell you about something even more wonderful - the amazing friendships in the ocean. Would you like to hear about how I became friends with George?\";\n    \n    return {\n      textResponse: redirectResponse,\n      emotion: 'gentle',\n      character: 'old-tom',\n      educationalContent: {\n        topic: 'Friendship and Ocean Life',\n        learningObjectives: ['Learn about positive relationships', 'Explore ocean friendships'],\n        ageAppropriate: true,\n        difficultyLevel: 'simple',\n        relatedTopics: ['friendship', 'cooperation', 'ocean animals']\n      },\n      followUpSuggestions: this.conversationStarters.slice(0, 3),\n      safetyValidation,\n      conversationContext: {\n        updated: false,\n        relationshipLevel: 'stranger',\n        newMemories: []\n      }\n    };\n  }\n\n  private createErrorResponse(request: AskOldTomRequest): AskOldTomResponse {\n    const errorResponse = \"Oh my, it seems the ocean currents are a bit choppy today! Let me try to help you in a different way. What would you like to learn about the ocean?\";\n    \n    return {\n      textResponse: errorResponse,\n      emotion: 'gentle',\n      character: 'old-tom',\n      educationalContent: {\n        topic: 'General Ocean Exploration',\n        learningObjectives: ['Encourage continued exploration'],\n        ageAppropriate: true,\n        difficultyLevel: 'simple',\n        relatedTopics: ['ocean exploration', 'marine life']\n      },\n      followUpSuggestions: this.conversationStarters.slice(0, 3),\n      safetyValidation: {\n        appropriate: true,\n        concerns: [],\n        recommendations: []\n      },\n      conversationContext: {\n        updated: false,\n        relationshipLevel: 'stranger',\n        newMemories: []\n      }\n    };\n  }\n\n  private extractTopicFromQuestion(question: string): string {\n    const questionLower = question.toLowerCase();\n    \n    if (questionLower.includes('whale') || questionLower.includes('ocean')) return 'marine life';\n    if (questionLower.includes('friend') || questionLower.includes('help')) return 'friendship';\n    if (questionLower.includes('george') || questionLower.includes('history')) return 'history';\n    if (questionLower.includes('deep') || questionLower.includes('current')) return 'ocean science';\n    \n    return 'general';\n  }\n\n  // Public utility methods\n  public getRandomConversationStarter(): string {\n    return this.conversationStarters[Math.floor(Math.random() * this.conversationStarters.length)];\n  }\n\n  public getKnowledgeAreas(): string[] {\n    return Array.from(this.knowledgeBase.keys());\n  }\n\n  public getAgeAppropriateTopics(age: number): string[] {\n    const ageGroup = this.determineAgeGroup(age);\n    const topics: string[] = [];\n    \n    this.knowledgeBase.forEach((knowledge, key) => {\n      const ageContent = knowledge.ageRanges[ageGroup];\n      if (ageContent && ageContent.concepts.length > 0) {\n        topics.push(knowledge.name);\n      }\n    });\n    \n    return topics;\n  }\n\n  public validateTopicAppropriateForAge(topic: string, age: number): boolean {\n    const ageGroup = this.determineAgeGroup(age);\n    const knowledge = this.knowledgeBase.get(topic);\n    \n    if (!knowledge) return true; // Default to appropriate if unknown\n    \n    const ageContent = knowledge.ageRanges[ageGroup];\n    return ageContent && ageContent.concepts.length > 0;\n  }\n}\n\nexport const askOldTomService = new AskOldTomService();\nexport default AskOldTomService;